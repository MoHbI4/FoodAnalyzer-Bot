# Инструкция по настройке и развертыванию FoodAnalyzer Bot

Эта инструкция поможет вам настроить и запустить бота для анализа БЖУ и калорийности блюд по фотографиям.

## 1. Подготовка окружения

### Системные требования
- Python 3.8 или выше
- Redis сервер
- Доступ к интернету для API-запросов

### Установка зависимостей
```bash
pip install -r requirements.txt
```

## 2. Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта со следующими параметрами:

```
BOT_TOKEN=ваш_токен_бота_от_botfather
CHANNEL_ID=@ваш_канал_или_его_id
CHANNEL_NAME=имя_канала_без_@
ADMIN_USER_ID=ваш_id_в_телеграм
OPENAI_API_KEY=ваш_ключ_api_openai
REDIS_URL=redis://localhost:6379/0
IMGUR_CLIENT_ID=ваш_imgur_client_id
```

### Получение необходимых ключей и ID:
1. **BOT_TOKEN**: Создайте бота через [@BotFather](https://t.me/BotFather) и получите токен
2. **CHANNEL_ID и CHANNEL_NAME**: Создайте канал в Telegram, добавьте бота как администратора
3. **ADMIN_USER_ID**: Узнайте свой ID через [@userinfobot](https://t.me/userinfobot)
4. **OPENAI_API_KEY**: Получите ключ на [OpenAI](https://platform.openai.com/account/api-keys) или используйте альтернативный API (в коде используется kluster.ai)
5. **IMGUR_CLIENT_ID**: Зарегистрируйтесь на [Imgur API](https://api.imgur.com/oauth2/addclient) и получите Client ID

## 3. Настройка Redis

### Установка Redis
- **Linux**: `sudo apt install redis-server`
- **macOS**: `brew install redis`
- **Windows**: Скачайте [Redis для Windows](https://github.com/microsoftarchive/redis/releases)

### Запуск Redis
- **Linux/macOS**: `redis-server`
- **Windows**: Запустите `redis-server.exe`

## 4. Настройка промпта

Файл `prompt.txt` уже содержит базовый промпт для анализа фотографий. При необходимости вы можете его отредактировать.

## 5. Запуск бота

### Локальный запуск
```bash
python main.py
```

### Запуск в Docker

1. Убедитесь, что Docker и Docker Compose установлены
2. Запустите контейнеры:
```bash
docker-compose up -d
```

## 6. Администрирование бота

После запуска бота вы можете использовать следующие команды администратора:

- `/stats` - Получить статистику использования бота
- `/get_prompt` - Посмотреть текущий промпт
- `/set_prompt` - Изменить промпт для анализа фотографий

## 7. Альтернативное хранение изображений

По умолчанию бот использует Imgur для хранения изображений. Если вы хотите использовать собственный сервер:

1. Настройте в `.env` дополнительные переменные:
```
VPS_IMAGE_DIR=/путь/к/папке/с/изображениями
VPS_IMAGE_URL=http://ваш-домен.com/images/
```

2. Измените код в `handlers/user_handlers.py`, заменив вызов `upload_image_to_imgur` на `upload_image_to_vps`

## 8. Проверка работоспособности

1. Откройте чат с ботом в Telegram
2. Отправьте команду `/start`
3. Подпишитесь на указанный канал
4. Отправьте фотографию блюда
5. Получите анализ БЖУ и калорийности

## Устранение неполадок

### Бот не отвечает
- Проверьте логи в файле `bot.log`
- Убедитесь, что Redis запущен и доступен
- Проверьте правильность токена бота

### Ошибки при анализе изображений
- Проверьте валидность OPENAI_API_KEY
- Убедитесь, что IMGUR_CLIENT_ID настроен правильно
- Проверьте доступность API сервисов

### Проблемы с Docker
- Проверьте логи контейнеров: `docker-compose logs`
- Убедитесь, что порты не заняты другими сервисами

## Дополнительные настройки

### Изменение модели ИИ
Если вы хотите использовать другую модель, отредактируйте файл `services/ai_service.py`, изменив параметр `model` в функции `analyze_food_image`.

### Настройка логирования
Параметры логирования можно изменить в файле `main.py`, отредактировав настройки `logging.basicConfig`.